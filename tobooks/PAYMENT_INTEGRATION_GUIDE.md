# Tobooks 微信支付集成指南

## 🎯 功能概述

本集成实现了通过微信Native支付购买Tobooks完整版的功能。用户点击"立即购买"按钮后，会弹出支付二维码，用户扫码支付成功后自动解锁完整版功能。

## 📁 文件结构

```
tobooks/
├── index.html                    # 主页面，包含支付按钮和模态框
├── payment.js                    # 前端支付逻辑
├── nativePaySDK/                 # 支付SDK目录
│   ├── payment-server.js         # 后端支付服务器
│   ├── qrcode.min.js            # 二维码生成库
│   └── package.json             # 依赖配置
├── start-payment-server.sh      # 支付服务器启动脚本
└── PAYMENT_INTEGRATION_GUIDE.md # 本说明文档
```

## 🚀 快速开始

### 1. 启动支付服务器

```bash
# 方法1：使用启动脚本（推荐）
./start-payment-server.sh

# 方法2：手动启动
cd nativePaySDK
npm install
node payment-server.js
```

支付服务器将在 `http://localhost:3003` 启动。

### 2. 配置微信支付

编辑 `nativePaySDK/payment-server.js` 中的微信支付配置：

```javascript
const WECHAT_CONFIG = {
    appid: 'your_wechat_appid',           // 你的微信AppID
    mchid: 'your_merchant_id',            // 你的商户号
    description: '在线支付',
    privateKeyPath: './apiclient_key.pem', // 你的私钥文件路径
    serialNo: 'your_certificate_serial',  // 你的证书序列号
    apiKey: 'your_api_key'                // 你的API密钥
};
```

### 3. 测试支付功能

1. 打开 `index.html`
2. 点击"立即购买"按钮
3. 扫码支付（测试环境）
4. 支付成功后页面自动刷新并解锁功能

## 💳 支付流程

### 前端流程

1. **用户点击购买按钮** → 检查登录状态
2. **创建支付订单** → 调用 `/api/create-payment` 接口
3. **显示支付二维码** → 使用 `qrcode.min.js` 生成二维码
4. **轮询支付状态** → 每5秒查询一次支付状态
5. **支付成功处理** → 标记为付费用户，刷新页面

### 后端流程

1. **接收支付请求** → 验证参数，生成订单号
2. **调用微信支付API** → 创建Native支付订单
3. **返回二维码URL** → 前端生成二维码
4. **处理支付回调** → 微信支付成功后回调
5. **更新订单状态** → 标记订单为已支付

## 🔧 配置说明

### 产品信息配置

在 `payment.js` 中配置产品信息：

```javascript
const PAYMENT_CONFIG = {
    API_URL: 'http://localhost:3003',
    PRODUCT_INFO: {
        id: 'tobooks_premium',      // 产品ID
        name: 'Tobooks完整版',      // 产品名称
        price: 99.00,               // 价格（元）
        amount: 9900                // 价格（分）
    },
    DEV_MODE: false                 // 是否开发模式
};
```

### 微信支付配置

在 `payment-server.js` 中配置微信支付参数：

- `appid`: 微信小程序/公众号AppID
- `mchid`: 微信支付商户号
- `privateKeyPath`: 商户私钥文件路径
- `serialNo`: 商户证书序列号
- `apiKey`: 商户API密钥

## 🎨 界面说明

### 支付模态框

- **标题**: "微信支付"
- **二维码**: 自动生成的支付二维码
- **订单信息**: 显示订单号和金额
- **关闭按钮**: 可手动关闭支付窗口

### 支付成功模态框

- **成功图标**: 🎉
- **提示文字**: "支付成功！高级功能已解锁，感谢您的支持！"
- **开始使用按钮**: 点击后刷新页面

## 🔍 调试技巧

### 1. 查看控制台日志

支付服务器会输出详细的日志信息：
- 支付订单创建过程
- 微信支付API调用结果
- 支付状态查询结果
- 回调处理过程

### 2. 测试支付流程

- 使用微信支付测试环境
- 模拟支付成功回调
- 检查订单状态更新

### 3. 常见问题排查

- 检查微信支付配置是否正确
- 确认回调地址是否可访问
- 验证证书文件路径是否正确
- 检查网络连接是否正常

## ⚠️ 注意事项

### 1. 生产环境配置

- 修改回调地址为你的域名
- 配置HTTPS证书
- 设置正确的端口号
- 更新微信支付配置为生产环境

### 2. 安全性

- 验证支付回调的真实性
- 防止重复支付
- 保护用户隐私信息
- 定期更新证书和密钥

### 3. 错误处理

- 支付失败时给用户友好提示
- 网络异常时的重试机制
- 订单超时处理
- 异常情况的日志记录

## 📞 技术支持

如果在集成过程中遇到问题，请检查：

1. 微信支付配置是否正确
2. 网络连接是否正常
3. 控制台是否有错误信息
4. 支付服务器是否正常启动
5. 业务字段是否已根据实际需求调整

---

**重要提醒**: 
- 本集成方案仅提供基础的支付功能，实际业务中请根据具体需求进行调整和完善
- 请确保在生产环境中使用正确的微信支付配置和域名
- 建议在测试环境充分测试后再部署到生产环境
