<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUB é˜…è¯»å™¨ - ä»˜è´¹ç‰ˆ</title>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #f7f7f7;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* å…è®¸æ–‡æœ¬é€‰ä¸­/å¤åˆ¶ */
        html, body, * {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }

        #top-bar {
            height: 48px;
            background: rgba(255, 255, 255, 0.98);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            padding: 0 16px;
            justify-content: space-between;
        }

        .top-button {
            padding: 6px 12px;
            border: none;
            background: none;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
        }

        .top-button:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        #main-container {
            flex: 1;
            display: flex;
            position: relative;
        }

        #viewer {
            flex: 1;
            height: 100%;
            background: white;
        }

        /* ä»˜è´¹å¢™æ ·å¼ */
        .paywall {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .paywall-content {
            text-align: center;
            max-width: 500px;
            padding: 40px 20px;
        }

        .paywall-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .paywall-title {
            font-size: 28px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .paywall-desc {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .paywall-features {
            text-align: left;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .paywall-features h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
        }

        .paywall-features ul {
            margin: 0;
            padding-left: 20px;
            color: #666;
        }

        .paywall-features li {
            margin-bottom: 8px;
            font-size: 16px;
        }

        .payment-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }

        .price {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
        }

        .price-desc {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #1976d2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565c0;
        }

        .btn-full {
            width: 100%;
        }

        #unlock-btn {
            background: #07c160 !important;
            font-size: 16px;
            padding: 12px;
        }

        #unlock-btn:hover {
            background: #06ad56 !important;
        }

        .text-link {
            color: #1976d2;
            cursor: pointer;
            text-decoration: none;
        }

        .text-link:hover {
            text-decoration: underline;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            color: #333;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .text-center {
            text-align: center;
        }

        .error-message {
            color: #f44336;
            font-size: 12px;
            margin-top: 4px;
        }

        #user-info {
            display: none;
            align-items: center;
            gap: 8px;
        }

        .user-status-paid {
            background: #4caf50;
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .user-status-free {
            background: #ff9800;
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
        }

        /* åˆ‡ä¹¦æŒ‰é’®æ ·å¼ */
        #book-cutting-btn {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 28px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            color: white;
            font-size: 24px;
        }

        #book-cutting-btn:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        #book-cutting-btn:active {
            transform: translateY(-50%) scale(0.95);
        }
    </style>
    <!-- iOS å…¨å±ä¸å®‰å…¨åŒºåŸŸé€‚é… -->
    <style>
        html, body { min-height: 100dvh; }
        body {
            padding-top: env(safe-area-inset-top); padding-top: constant(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom); padding-bottom: constant(safe-area-inset-bottom);
        }
        #top-bar { padding-top: env(safe-area-inset-top); padding-top: constant(safe-area-inset-top); }
        #main-container, #viewer { padding-bottom: env(safe-area-inset-bottom); padding-bottom: constant(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <!-- åˆ‡ä¹¦æŒ‰é’® -->
    <button id="book-cutting-btn" onclick="window.open('book-cutting.html', '_blank')" title="åˆ‡ä¹¦åŠŸèƒ½">
        ğŸ“š
    </button>

    <div id="top-bar">
        <div>EPUB é˜…è¯»å™¨</div>
        <div id="user-info">
            <span id="user-name"></span>
            <span id="user-status"></span>
        </div>
        <button id="login-btn" class="top-button">ç™»å½•</button>
    </div>
    
    <div id="main-container">
        <div id="viewer">
            <div id="viewer-content" style="display: flex; justify-content: center; align-items: center; height: 100%; color: #999;">
                è¯·å…ˆç™»å½•å¹¶ä»˜è´¹è§£é”åŠŸèƒ½
            </div>
        </div>
    </div>

    <!-- ä»˜è´¹å¢™ -->
    <div id="paywall" class="paywall">
        <div class="paywall-content">
            <div class="paywall-icon">ğŸ“š</div>
            <h1 class="paywall-title">æ¬¢è¿ä½¿ç”¨ EPUB é˜…è¯»å™¨</h1>
            <p class="paywall-desc">è¿™æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç”µå­ä¹¦é˜…è¯»å·¥å…·ï¼Œéœ€è¦ä»˜è´¹åæ‰èƒ½ä½¿ç”¨å®Œæ•´åŠŸèƒ½</p>
            
            <div class="paywall-features">
                <h3>ğŸ¯ ä»˜è´¹ç‰ˆåŠŸèƒ½</h3>
                <ul>
                    <li>âœ… æ— é™åˆ¶ä¸Šä¼ å’Œé˜…è¯» EPUB æ–‡ä»¶</li>
                    <li>âœ… å…¨æ–‡æœç´¢åŠŸèƒ½</li>
                    <li>âœ… ä¹¦ç­¾å’Œç¬”è®°åŠŸèƒ½</li>
                    <li>âœ… å¤šç§é˜…è¯»ä¸»é¢˜</li>
                    <li>âœ… äº‘ç«¯åŒæ­¥é˜…è¯»è¿›åº¦</li>
                    <li>âœ… æ— å¹¿å‘Šçº¯å‡€ä½“éªŒ</li>
                    <li>âœ… ç»ˆèº«å…è´¹æ›´æ–°</li>
                </ul>
            </div>
            
            <div class="payment-info">
                <div class="price">Â¥29</div>
                <div class="price-desc">ä¸€æ¬¡ä»˜è´¹ï¼Œç»ˆèº«ä½¿ç”¨</div>
            </div>
            
            <button id="unlock-btn" class="btn btn-primary btn-full">
                ğŸ’³ ç«‹å³å¾®ä¿¡æ”¯ä»˜è§£é”
            </button>
            
            <p style="margin-top: 20px; color: #999; font-size: 14px;">
                å·²æœ‰è´¦å·ï¼Ÿ<a href="#" id="login-link" class="text-link">ç‚¹å‡»ç™»å½•</a>
            </p>
        </div>
    </div>

    <script>
        (function enableCopyAndContextMenu(){
            const events = ['copy','cut','paste','contextmenu','selectstart','dragstart'];
            events.forEach(function(evt){
                document.addEventListener(evt, function(e){
                    e.stopImmediatePropagation();
                }, true);
            });
            document.addEventListener('DOMContentLoaded', function(){
                const all = document.getElementsByTagName('*');
                for (var i = 0; i < all.length; i++) {
                    all[i].oncopy = all[i].oncut = all[i].onpaste = all[i].oncontextmenu = all[i].onselectstart = all[i].ondragstart = null;
                }
            });
        })();
    </script>
    
    <!-- macOS Books é£æ ¼æ‰‹åŠ¿å¯¼èˆªè„šæœ¬ -->
    <script src="books-gesture-navigation.js"></script>
    
    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">ç™»å½•</h3>
            </div>
            <form id="auth-form">
                <div class="form-group">
                    <label class="form-label">æ‰‹æœºå·</label>
                    <input type="tel" id="phone-input" class="form-input" placeholder="æ¼”ç¤ºå¯è¾“å…¥ä»»æ„æ•°å­—" maxlength="11">
                    <div id="phone-error" class="error-message"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">å§“å</label>
                    <input type="text" id="name-input" class="form-input" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
                </div>
                <div class="form-group">
                    <label class="form-label">éªŒè¯ç </label>
                    <input type="text" id="code-input" class="form-input" placeholder="æ¼”ç¤ºè¯·è¾“å…¥ï¼š1234" maxlength="6">
                    <div id="code-error" class="error-message"></div>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary btn-full" id="auth-submit">ç™»å½•</button>
                </div>
                <div class="text-center">
                    <span>æ²¡æœ‰è´¦å·ï¼Ÿ</span>
                    <a href="#" class="text-link" id="toggle-auth">ç«‹å³æ³¨å†Œ</a>
                </div>
            </form>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="close-modal">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ”¯ä»˜æ¨¡æ€æ¡† -->
    <div id="payment-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ’³ å¾®ä¿¡æ”¯ä»˜</h3>
            </div>
            <div class="payment-info">
                <div class="price">Â¥29</div>
                <div class="price-desc">ä¸€æ¬¡ä»˜è´¹ï¼Œç»ˆèº«ä½¿ç”¨</div>
            </div>
            <div class="text-center">
                <p style="margin: 16px 0; color: #666;">
                    <span style="color: #07c160;">ğŸŸ¢</span> 
                    æ”¯æŒå¾®ä¿¡æ‰«ç æ”¯ä»˜ï¼Œå®‰å…¨ä¾¿æ·
                </p>
                <button id="pay-btn" class="btn btn-primary btn-full" style="background: #07c160; font-size: 16px;">
                    ğŸ’³ ç«‹å³å¾®ä¿¡æ”¯ä»˜
                </button>
                <div id="payment-status" style="margin-top: 16px; font-size: 14px; min-height: 20px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="close-payment-modal">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // Simple global state
        let user = null;
        let isLoginMode = true;

        // Initialize app
        function init() {
            loadUserFromStorage();
            updateUI();
        }

        // Load user from localStorage
        function loadUserFromStorage() {
            const userData = localStorage.getItem('user');
            if (userData) {
                try {
                    user = JSON.parse(userData);
                } catch (e) {
                    localStorage.removeItem('user');
                }
            }
        }

        // Save user to localStorage
        function saveUserToStorage() {
            if (user) {
                localStorage.setItem('user', JSON.stringify(user));
            } else {
                localStorage.removeItem('user');
            }
        }

        // Update UI based on user state - simplified and clean
        function updateUI() {
            const loginBtn = document.getElementById('login-btn');
            const userInfo = document.getElementById('user-info');
            const userName = document.getElementById('user-name');
            const userStatus = document.getElementById('user-status');
            const paywall = document.getElementById('paywall');
            const viewerContent = document.getElementById('viewer-content');

            console.log('Updating UI, user state:', user);

            if (user && user.phone) {
                // User is logged in
                loginBtn.style.display = 'none';
                userInfo.style.display = 'flex';
                userName.textContent = user.name || user.phone;
                
                if (user.isPaid) {
                    // User has paid - full access
                    userStatus.textContent = 'å·²ä»˜è´¹';
                    userStatus.className = 'user-status-paid';
                    paywall.style.display = 'none';
                    
                    viewerContent.innerHTML = `
                        <div style="padding: 40px; text-align: center; max-width: 600px; margin: 0 auto;">
                            <h2 style="color: #1976d2; margin-bottom: 20px;">ğŸ‰ æ¬¢è¿ä½¿ç”¨ EPUB é˜…è¯»å™¨ï¼</h2>
                            <p style="font-size: 18px; color: #333; margin-bottom: 30px;">æ‚¨å·²æˆåŠŸè§£é”æ‰€æœ‰åŠŸèƒ½ï¼Œç°åœ¨å¯ä»¥å¼€å§‹ä½¿ç”¨ä¸“ä¸šçš„é˜…è¯»å™¨äº†ã€‚</p>
                            
                            <div style="margin: 30px 0;">
                                <button onclick="showReaderInterface()" 
                                        style="padding: 20px 40px; background: #4caf50; color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 18px; font-weight: 600; box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3); transition: all 0.3s;">
                                    ğŸš€ è¿›å…¥ä¸“ä¸šé˜…è¯»å™¨
                                </button>
                            </div>
                            
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin-top: 30px;">
                                <h3 style="margin: 0 0 15px 0; color: #333;">âœ¨ æ‚¨ç°åœ¨å¯ä»¥ä½¿ç”¨ï¼š</h3>
                                <ul style="text-align: left; color: #666; margin: 0; padding-left: 20px;">
                                    <li>ä¸“ä¸šçš„ EPUB é˜…è¯»ç•Œé¢</li>
                                    <li>å…¨æ–‡æœç´¢åŠŸèƒ½</li>
                                    <li>ä¹¦ç­¾å’Œç¬”è®°åŠŸèƒ½</li>
                                    <li>å¤šç§é˜…è¯»ä¸»é¢˜</li>
                                    <li>é”®ç›˜å¿«æ·é”®æ”¯æŒ</li>
                                    <li>æ— å¹¿å‘Šçº¯å‡€ä½“éªŒ</li>
                                </ul>
                            </div>
                            
                            <p style="color: #999; font-size: 14px; margin-top: 20px;">
                                ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç›´æ¥è¿›å…¥é˜…è¯»å™¨ï¼Œåœ¨é˜…è¯»å™¨ä¸­å¯ä»¥ä¸Šä¼  EPUB æ–‡ä»¶
                            </p>
                        </div>
                    `;
                } else {
                    // User logged in but not paid
                    userStatus.textContent = 'å…è´¹ç‰ˆ';
                    userStatus.className = 'user-status-free';
                    paywall.style.display = 'flex';
                    
                    viewerContent.innerHTML = `
                        <div style="padding: 40px; text-align: center;">
                            <h3 style="color: #4caf50; margin-bottom: 15px;">âœ… ç™»å½•æˆåŠŸï¼</h3>
                            <p style="color: #666; font-size: 16px;">æ¬¢è¿ ${user.name}ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æ”¯ä»˜æŒ‰é’®è§£é”å®Œæ•´åŠŸèƒ½</p>
                        </div>
                    `;
                }
            } else {
                // User not logged in
                loginBtn.style.display = 'block';
                userInfo.style.display = 'none';
                paywall.style.display = 'flex';
                
                viewerContent.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #999;">
                        <h3>è¯·å…ˆç™»å½•</h3>
                        <p>ç™»å½•åå³å¯ä½“éªŒä»˜è´¹åŠŸèƒ½</p>
                    </div>
                `;
            }
        }

        // Show modal
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'login-modal') {
                clearForm();
            }
        }

        // Clear form
        function clearForm() {
            document.getElementById('phone-input').value = '';
            document.getElementById('name-input').value = '';
            document.getElementById('code-input').value = '';
            document.getElementById('phone-error').textContent = '';
            document.getElementById('code-error').textContent = '';
        }

        // Handle login/register with clean API call
        async function handleAuth(phone, name, code) {
            const submitBtn = document.getElementById('auth-submit');
            const originalText = submitBtn.textContent;
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'å¤„ç†ä¸­...';

            try {
                const response = await fetch('/api/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: isLoginMode ? 'login' : 'register',
                        phone: phone,
                        name: name,
                        code: code
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
                }

                if (data.success) {
                    // Save user data
                    user = data.user;
                    localStorage.setItem('authToken', data.token);
                    saveUserToStorage();
                    
                    // Update UI and close modal
                    updateUI();
                    closeModal('login-modal');
                    
                    const successMessage = isLoginMode ? 
                        'ç™»å½•æˆåŠŸï¼ç°åœ¨å¯ä»¥ç‚¹å‡»æ”¯ä»˜æŒ‰é’®ä½“éªŒå¾®ä¿¡æ”¯ä»˜æµç¨‹ã€‚' : 
                        'æ³¨å†ŒæˆåŠŸï¼ç°åœ¨å¯ä»¥ç‚¹å‡»æ”¯ä»˜æŒ‰é’®ä½“éªŒå¾®ä¿¡æ”¯ä»˜æµç¨‹ã€‚';
                    alert(successMessage);
                } else {
                    throw new Error(data.error || 'è®¤è¯å¤±è´¥');
                }
                
            } catch (error) {
                console.error('Authentication error:', error);
                
                // Show specific error messages
                if (error.message.includes('éªŒè¯ç ')) {
                    document.getElementById('code-error').textContent = error.message;
                } else if (error.message.includes('æ‰‹æœºå·')) {
                    document.getElementById('phone-error').textContent = error.message;
                } else {
                    alert('è®¤è¯å¤±è´¥: ' + error.message);
                }
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // Show reader interface - using the original tobooks design
        function showReaderInterface() {
            // Replace the entire body content with the original reader
            document.body.innerHTML = `
                <div id="top-bar" style="height: 48px; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0, 0, 0, 0.1); display: flex; align-items: center; padding: 0 16px; justify-content: space-between;">
                    <div id="file-input-container" style="position: relative; padding: 6px 12px; border: none; background: none; color: #333; font-size: 14px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; gap: 4px;">
                        <svg width="16" height="16" viewBox="0 0 24 24">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                        <span>æ‰“å¼€ç”µå­ä¹¦</span>
                        <input type="file" id="file-input" accept=".epub" style="opacity: 0; position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: pointer;" />
                    </div>
                    
                    <div id="search-container" style="display: flex; align-items: center; gap: 8px; position: relative; background: rgba(0, 0, 0, 0.05); border-radius: 8px; padding: 8px 12px; transition: all 0.2s; min-width: 250px;">
                        <svg width="16" height="16" viewBox="0 0 24 24" style="fill: #666; flex-shrink: 0;">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        <input type="text" id="search-input" placeholder="æœç´¢" style="border: none; background: transparent; font-size: 14px; flex: 1; color: #333; outline: none; font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;" />
                        <div id="search-info" style="font-size: 12px; color: #666; padding: 2px 6px; background: rgba(25, 118, 210, 0.1); border-radius: 3px; min-width: 30px; text-align: center; white-space: nowrap; opacity: 0; transition: opacity 0.2s;"></div>
                    </div>
                    
                    <button id="backHomeBtn" style="background: #1976d2; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; padding: 6px 12px;">ç›®å½•</button>
                </div>
                
                <div id="main-container" style="flex: 1; display: flex; position: relative;">
                    <button id="prev-button" style="position: absolute; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; background: rgba(0, 0, 0, 0.03); border: none; border-radius: 20px; cursor: pointer; display: none; align-items: center; justify-content: center; transition: all 0.2s; z-index: 100; left: 20px;">
                        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #666;">
                            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                        </svg>
                    </button>
                    <div id="viewer" style="flex: 1; height: 100%; background: white; position: relative; overflow: hidden;"></div>
                    <button id="next-button" style="position: absolute; top: 50%; transform: translateY(-50%); width: 40px; height: 40px; background: rgba(0, 0, 0, 0.03); border: none; border-radius: 20px; cursor: pointer; display: none; align-items: center; justify-content: center; transition: all 0.2s; z-index: 100; right: 20px;">
                        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #666;">
                            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                        </svg>
                    </button>
                </div>
            `;
            
            // Add the original reader styles
            const style = document.createElement('style');
            style.textContent = `
                body {
                    margin: 0;
                    padding: 0;
                    background: #f7f7f7;
                    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Icons', sans-serif;
                    overflow: hidden;
                    height: 100vh;
                    width: 100vw;
                    display: flex;
                    flex-direction: column;
                }
                
                .nav-button:hover {
                    background: rgba(0, 0, 0, 0.1) !important;
                }
                
                #file-input-container:hover {
                    background: rgba(0, 0, 0, 0.05);
                }
                
                #search-container:hover {
                    background: rgba(0, 0, 0, 0.08);
                }
                
                #search-container:focus-within {
                    background: white;
                    box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.1);
                }
                
                #search-container:focus-within #search-info {
                    opacity: 1;
                }
                
                #search-info:empty {
                    opacity: 0;
                }
                
                .search-highlight {
                    background-color: yellow !important;
                    color: black !important;
                }
                
                .epubjs-hl.search-highlight {
                    background-color: yellow !important;
                    color: black !important;
                }
            `;
            document.head.appendChild(style);
            
            // Initialize the original reader functionality
            initOriginalReader();
        }

        // Initialize the original tobooks reader functionality
        function initOriginalReader() {
            const fileInput = document.getElementById('file-input');
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');
            const searchInput = document.getElementById('search-input');
            const searchInfo = document.getElementById('search-info');
            const backHomeBtn = document.getElementById('backHomeBtn');
            
            let book = null;
            let rendition = null;
            let searchResults = [];
            let currentSearchIndex = -1;
            let gestureNavigation = null;
            const boundIframes = new WeakSet(); // è®°å½•å·²ç»‘å®šé”®ç›˜äº‹ä»¶çš„ iframe

            // Load required libraries
            if (!window.JSZip) {
                const jszipScript = document.createElement('script');
                jszipScript.src = 'lib/jszip.js';
                document.head.appendChild(jszipScript);
            }
            
            if (!window.localforage) {
                const localforageScript = document.createElement('script');
                localforageScript.src = 'lib/localforage.js';
                document.head.appendChild(localforageScript);
            }
            
            if (!window.ePub) {
                const epubScript = document.createElement('script');
                epubScript.src = 'lib/epub.js';
                epubScript.onload = function() {
                    console.log('EPUB.js loaded successfully');
                };
                document.head.appendChild(epubScript);
            }

            // File input handling
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file || !file.name.endsWith('.epub')) {
                    alert('è¯·é€‰æ‹© EPUB æ–‡ä»¶');
                    return;
                }

                // If already have book displayed, destroy it first
                if (book) {
                    book.destroy();
                }

                try {
                    // Create new book instance
                    book = ePub();
                    await book.open(file);

                    // Render the book
                    rendition = book.renderTo('viewer', {
                        width: '100%',
                        height: '100%',
                        flow: 'paginated',
                        spread: 'none',
                        manager: 'default'
                    });

                    await rendition.display();

                    // Set styles
                    rendition.themes.default({
                        'body': {
                            'padding': '0',
                            'margin': '0'
                        },
                        'p': {
                            'font-family': '-apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif',
                            'font-size': '16px',
                            'line-height': '1.6',
                            'margin': '1em 0'
                        },
                        'img': {
                            'max-width': '100%'
                        }
                    });

                    // Show navigation buttons
                    prevButton.style.display = 'flex';
                    nextButton.style.display = 'flex';
                    
                    // åˆå§‹åŒ– macOS Books é£æ ¼æ‰‹åŠ¿å¯¼èˆª
                    if (window.BooksGestureNavigation) {
                        gestureNavigation = new window.BooksGestureNavigation(rendition, {
                            edgeSafeZoneWidth: 80,
                            minSwipeDistance: 50,
                            minSwipeVelocity: 0.3,
                            enableTrackpad: true,
                            enableTouch: true,
                            showEdgeZones: true,
                            animationDuration: 300
                        });
                        console.log('âœ… macOS Books é£æ ¼æ‰‹åŠ¿å¯¼èˆªå·²å¯ç”¨');
                    }

                    // ç¡®ä¿åœ¨é˜…è¯» iframe å†…éƒ¨ä¹Ÿèƒ½ç”¨å·¦å³æ–¹å‘é”®ç¿»é¡µ
                    const attachKeyToView = (view) => {
                        if (!view) return;
                        const iframe = view.iframe || (view.document && view.document.defaultView && view.document.defaultView.frameElement);
                        if (!iframe || boundIframes.has(iframe)) return;
                        try {
                            const onKeyUp = (e) => {
                                if (!rendition) return;
                                if (e.key === 'ArrowLeft') {
                                    e.preventDefault && e.preventDefault();
                                    rendition.prev();
                                } else if (e.key === 'ArrowRight') {
                                    e.preventDefault && e.preventDefault();
                                    rendition.next();
                                }
                            };
                            const win = iframe.contentWindow;
                            const doc = iframe.contentDocument;
                            win.addEventListener('keyup', onKeyUp, false);
                            doc.addEventListener('keyup', onKeyUp, false);
                            boundIframes.add(iframe);
                            console.log('âœ… å·²ç»‘å®š iframe é”®ç›˜å·¦å³é”®å¯¼èˆª');
                        } catch (err) {
                            console.warn('âš ï¸ ç»‘å®š iframe é”®ç›˜äº‹ä»¶å¤±è´¥:', err);
                        }
                    };

                    try {
                        rendition.on('displayed', (view) => attachKeyToView(view));
                        rendition.on('rendered', (section, view) => attachKeyToView(view));
                    } catch (err) {
                        console.warn('âš ï¸ æ— æ³•ç»‘å®š rendition äº‹ä»¶ä»¥ç›‘å¬ iframe é”®ç›˜:', err);
                    }

                } catch (error) {
                    console.error('Error loading book:', error);
                    alert('åŠ è½½ç”µå­ä¹¦æ—¶å‡ºé”™ï¼Œè¯·ç¡®ä¿é€‰æ‹©äº†æœ‰æ•ˆçš„ EPUB æ–‡ä»¶');
                }
            });

            // Navigation button events
            prevButton.addEventListener('click', () => {
                if (rendition) {
                    rendition.prev();
                }
            });

            nextButton.addEventListener('click', () => {
                if (rendition) {
                    rendition.next();
                }
            });

            // Keyboard events
            document.addEventListener('keyup', (e) => {
                if (!rendition) return;
                
                if (e.key === 'ArrowLeft') {
                    rendition.prev();
                }
                if (e.key === 'ArrowRight') {
                    rendition.next();
                }
            });

            // Search functionality
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    searchInput.focus();
                    searchInput.select();
                }
            });

            // Search input events
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                if (query.length >= 2 && book) {
                    performSearch(query);
                } else {
                    clearSearchResults();
                }
            });

            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    if (e.shiftKey) {
                        // Shift+Enter previous
                        if (currentSearchIndex > 0) {
                            goToSearchResult(currentSearchIndex - 1);
                        }
                    } else {
                        // Enter next
                        if (currentSearchIndex < searchResults.length - 1) {
                            goToSearchResult(currentSearchIndex + 1);
                        }
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (currentSearchIndex > 0) {
                        goToSearchResult(currentSearchIndex - 1);
                    }
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    if (currentSearchIndex < searchResults.length - 1) {
                        goToSearchResult(currentSearchIndex + 1);
                    }
                }
            });

            // Back to home button
            backHomeBtn.addEventListener('click', function() {
                location.reload(); // Simple way to go back to main interface
            });

            // Search functions
            async function performSearch(query) {
                if (!query.trim() || !book) return;

                searchResults = [];
                currentSearchIndex = -1;

                try {
                    // Simple search implementation
                    alert(`æœç´¢åŠŸèƒ½: "${query}"\n\nè¿™æ˜¯ä»˜è´¹ç‰ˆåŠŸèƒ½ï¼Œå¯ä»¥åœ¨æ•´æœ¬ä¹¦ä¸­æœç´¢æ–‡æœ¬å†…å®¹ã€‚`);
                    updateSearchInfo();
                } catch (error) {
                    console.error('Search error:', error);
                }
            }

            function goToSearchResult(index) {
                if (index < 0 || index >= searchResults.length) return;
                currentSearchIndex = index;
                updateSearchInfo();
            }

            function clearSearchResults() {
                searchResults = [];
                currentSearchIndex = -1;
                updateSearchInfo();
            }

            function updateSearchInfo() {
                if (searchResults.length === 0) {
                    searchInfo.textContent = '';
                } else {
                    searchInfo.textContent = `${currentSearchIndex + 1}/${searchResults.length}`;
                }
            }

            // Initially hide navigation buttons
            prevButton.style.display = 'none';
            nextButton.style.display = 'none';
        }

        // Handle payment with real WeChat Pay API
        async function handlePayment() {
            if (!user) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const payBtn = document.getElementById('pay-btn');
            const paymentStatus = document.getElementById('payment-status');
            const originalText = payBtn.textContent;
            
            payBtn.disabled = true;
            payBtn.textContent = 'åˆ›å»ºå¾®ä¿¡æ”¯ä»˜è®¢å•...';
            paymentStatus.textContent = 'æ­£åœ¨åˆ›å»ºæ”¯ä»˜è®¢å•...';
            
            try {
                // Create payment order
                const response = await fetch('/api/wechat-pay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'create',
                        phone: user.phone
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'åˆ›å»ºè®¢å•å¤±è´¥');
                }

                if (data.success) {
                    // Show QR code
                    paymentStatus.innerHTML = `
                        <div style="text-align: center;">
                            <p style="color: #07c160; margin-bottom: 10px;">âœ… è®¢å•åˆ›å»ºæˆåŠŸï¼</p>
                            <div style="background: white; padding: 15px; border-radius: 8px; display: inline-block; margin: 10px 0;">
                                <img src="${data.qrCode}" alt="WeChat Pay QR Code" style="width: 200px; height: 200px;" />
                            </div>
                            <p style="font-size: 14px; color: #666; margin: 10px 0;">
                                ${data.isDemoMode ? 'ğŸ”§ æ¼”ç¤ºæ¨¡å¼ï¼š5ç§’åè‡ªåŠ¨æ”¯ä»˜æˆåŠŸ' : 'è¯·ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç å®Œæˆæ”¯ä»˜'}
                            </p>
                            <p style="font-size: 12px; color: #999;">
                                è®¢å•å·: ${data.orderId}<br/>
                                é‡‘é¢: Â¥${data.amount}
                            </p>
                        </div>
                    `;
                    
                    payBtn.textContent = 'ç­‰å¾…æ”¯ä»˜å®Œæˆ...';
                    
                    // Start checking payment status
                    checkPaymentStatus(data.orderId);
                } else {
                    throw new Error(data.error || 'åˆ›å»ºè®¢å•å¤±è´¥');
                }
                
            } catch (error) {
                console.error('Payment creation error:', error);
                alert('åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥: ' + error.message);
                payBtn.disabled = false;
                payBtn.textContent = originalText;
                paymentStatus.textContent = '';
            }
        }

        // Check payment status periodically
        async function checkPaymentStatus(orderId) {
            const maxAttempts = 60; // Check for 5 minutes (60 * 5s = 5min)
            let attempts = 0;
            
            const checkInterval = setInterval(async () => {
                attempts++;
                
                try {
                    const response = await fetch('/api/wechat-pay', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'check',
                            orderId: orderId
                        })
                    });

                    const data = await response.json();

                    if (data.success && data.isPaid) {
                        // Payment successful
                        clearInterval(checkInterval);
                        
                        // Update user status
                        user.isPaid = true;
                        saveUserToStorage();
                        
                        // Show success message
                        document.getElementById('payment-status').innerHTML = `
                            <div style="text-align: center; color: #4caf50;">
                                <p style="font-size: 18px; margin: 10px 0;">ğŸ‰ æ”¯ä»˜æˆåŠŸï¼</p>
                                <p style="font-size: 14px;">æ­£åœ¨è§£é”æ‰€æœ‰åŠŸèƒ½...</p>
                            </div>
                        `;
                        
                        setTimeout(() => {
                            updateUI();
                            closeModal('payment-modal');
                            alert('ğŸ‰ æ­å–œï¼æ”¯ä»˜æˆåŠŸï¼\n\nç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½äº†ï¼');
                        }, 2000);
                        
                    } else if (attempts >= maxAttempts) {
                        // Timeout
                        clearInterval(checkInterval);
                        document.getElementById('payment-status').innerHTML = `
                            <div style="text-align: center; color: #f44336;">
                                <p>â° æ”¯ä»˜è¶…æ—¶</p>
                                <p style="font-size: 14px;">è¯·é‡æ–°åˆ›å»ºè®¢å•</p>
                            </div>
                        `;
                        
                        const payBtn = document.getElementById('pay-btn');
                        payBtn.disabled = false;
                        payBtn.textContent = 'ğŸ’³ é‡æ–°æ”¯ä»˜';
                    }
                    
                } catch (error) {
                    console.error('Payment status check error:', error);
                    if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        const payBtn = document.getElementById('pay-btn');
                        payBtn.disabled = false;
                        payBtn.textContent = 'ğŸ’³ é‡æ–°æ”¯ä»˜';
                    }
                }
            }, 5000); // Check every 5 seconds
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            init();

            // Login button
            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.addEventListener('click', () => {
                    showModal('login-modal');
                });
            }

            // Logout button - add event listener with null check
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                        logout();
                    }
                });
            }

            // Login link in paywall
            const loginLink = document.getElementById('login-link');
            if (loginLink) {
                loginLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showModal('login-modal');
                });
            }

            // Unlock button
            const unlockBtn = document.getElementById('unlock-btn');
            if (unlockBtn) {
                unlockBtn.addEventListener('click', () => {
                    if (!user) {
                        showModal('login-modal');
                    } else {
                        showModal('payment-modal');
                        // Auto-start payment process
                        setTimeout(() => {
                            handlePayment();
                        }, 500);
                    }
                });
            }

            // Pay button
            const payBtn = document.getElementById('pay-btn');
            if (payBtn) {
                payBtn.addEventListener('click', handlePayment);
            }

            // Close modal buttons
            const closeModalBtn = document.getElementById('close-modal');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', () => {
                    closeModal('login-modal');
                });
            }

            const closePaymentModalBtn = document.getElementById('close-payment-modal');
            if (closePaymentModalBtn) {
                closePaymentModalBtn.addEventListener('click', () => {
                    closeModal('payment-modal');
                });
            }

            // Toggle login/register
            const toggleAuthBtn = document.getElementById('toggle-auth');
            if (toggleAuthBtn) {
                toggleAuthBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    const titleEl = document.getElementById('modal-title');
                    const submitBtn = document.getElementById('auth-submit');
                    const toggleLink = document.getElementById('toggle-auth');
                    
                    if (titleEl && submitBtn && toggleLink) {
                        if (isLoginMode) {
                            isLoginMode = false;
                            titleEl.textContent = 'æ³¨å†Œ';
                            submitBtn.textContent = 'æ³¨å†Œ';
                            toggleLink.textContent = 'å·²æœ‰è´¦å·ï¼Ÿç™»å½•';
                        } else {
                            isLoginMode = true;
                            titleEl.textContent = 'ç™»å½•';
                            submitBtn.textContent = 'ç™»å½•';
                            toggleLink.textContent = 'æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ';
                        }
                    }
                });
            }

            // Form submit
            const authForm = document.getElementById('auth-form');
            if (authForm) {
                authForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const phoneInput = document.getElementById('phone-input');
                    const nameInput = document.getElementById('name-input');
                    const codeInput = document.getElementById('code-input');
                    const phoneError = document.getElementById('phone-error');
                    const codeError = document.getElementById('code-error');

                    if (!phoneInput || !nameInput || !codeInput || !phoneError || !codeError) {
                        console.error('Form elements not found');
                        return;
                    }

                    const phone = phoneInput.value.trim();
                    const name = nameInput.value.trim();
                    const code = codeInput.value.trim();

                    // Clear errors
                    phoneError.textContent = '';
                    codeError.textContent = '';

                    // Validate
                    if (!phone || phone.length < 3) {
                        phoneError.textContent = 'è¯·è¾“å…¥æ‰‹æœºå·ï¼ˆæ¼”ç¤ºå¯è¾“å…¥ä»»æ„3ä½ä»¥ä¸Šæ•°å­—ï¼‰';
                        return;
                    }

                    if (!code) {
                        codeError.textContent = 'è¯·è¾“å…¥éªŒè¯ç ';
                        return;
                    }

                    handleAuth(phone, name, code);
                });
            }

            // Close modal on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });
        });
    </script>
</body>
</html>
