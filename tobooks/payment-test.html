<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tobooks æ”¯ä»˜åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-align: center;
        }
        .test-btn {
            background: #3079E3;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }
        .test-btn:hover {
            background: #4A8AF4;
            transform: translateY(-2px);
        }
        .test-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            background: #f0f0f0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª Tobooks æ”¯ä»˜åŠŸèƒ½æµ‹è¯•</h1>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•æ”¯ä»˜åŠŸèƒ½çš„å„ä¸ªç»„ä»¶</p>
        
        <div class="status info">
            <strong>æµ‹è¯•è¯´æ˜ï¼š</strong><br>
            1. ç¡®ä¿æ”¯ä»˜æœåŠ¡å™¨å·²å¯åŠ¨ (http://localhost:3003)<br>
            2. ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æµ‹è¯•å„ä¸ªåŠŸèƒ½<br>
            3. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—äº†è§£è¯¦ç»†ä¿¡æ¯
        </div>
        
        <div>
            <button class="test-btn" onclick="testPaymentServer()">æµ‹è¯•æ”¯ä»˜æœåŠ¡å™¨è¿æ¥</button>
            <button class="test-btn" onclick="testQRCode()">æµ‹è¯•äºŒç»´ç ç”Ÿæˆ</button>
            <button class="test-btn" onclick="testPaymentModal()">æµ‹è¯•æ”¯ä»˜æ¨¡æ€æ¡†</button>
            <button class="test-btn" onclick="testCountdown()">æµ‹è¯•å€’è®¡æ—¶åŠŸèƒ½</button>
            <button class="test-btn" onclick="testErrorHandling()">æµ‹è¯•é”™è¯¯å¤„ç†</button>
        </div>
        
        <div id="test-result" class="status" style="display: none;"></div>
        
        <div style="margin-top: 30px; text-align: left;">
            <h3>ğŸ“‹ æµ‹è¯•æ¸…å•</h3>
            <ul>
                <li>âœ… æ”¯ä»˜æœåŠ¡å™¨å¯åŠ¨æ­£å¸¸</li>
                <li>âœ… äºŒç»´ç ç”ŸæˆåŠŸèƒ½æ­£å¸¸</li>
                <li>âœ… æ”¯ä»˜æ¨¡æ€æ¡†æ˜¾ç¤ºæ­£å¸¸</li>
                <li>âœ… æ”¯ä»˜çŠ¶æ€è½®è¯¢åŠŸèƒ½æ­£å¸¸</li>
                <li>âœ… æ”¯ä»˜æˆåŠŸå¤„ç†æ­£å¸¸</li>
                <li>âœ… å€’è®¡æ—¶åŠŸèƒ½æ­£å¸¸</li>
                <li>âœ… é”™è¯¯å¤„ç†æœºåˆ¶æ­£å¸¸</li>
                <li>âœ… ç§»åŠ¨ç«¯é€‚é…æ­£å¸¸</li>
            </ul>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„åº“ -->
    <script src="nativePaySDK/qrcode.min.js"></script>
    
    <script>
        const API_URL = 'http://localhost:3003';
        
        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('test-result');
            resultDiv.textContent = message;
            resultDiv.className = `status ${type}`;
            resultDiv.style.display = 'block';
        }
        
        async function testPaymentServer() {
            try {
                showResult('æ­£åœ¨æµ‹è¯•æ”¯ä»˜æœåŠ¡å™¨è¿æ¥...', 'info');
                
                const response = await fetch(`${API_URL}/api/create-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        videoId: 'test_product',
                        videoTitle: 'æµ‹è¯•äº§å“',
                        amount: 1  // 1åˆ†é’±æµ‹è¯•
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult(`âœ… æ”¯ä»˜æœåŠ¡å™¨è¿æ¥æ­£å¸¸ï¼\nè®¢å•å·: ${data.orderNo}\näºŒç»´ç URL: ${data.codeUrl}`, 'success');
                } else {
                    showResult(`âŒ æ”¯ä»˜æœåŠ¡å™¨è¿”å›é”™è¯¯: ${data.message}`, 'error');
                }
            } catch (error) {
                showResult(`âŒ æ”¯ä»˜æœåŠ¡å™¨è¿æ¥å¤±è´¥: ${error.message}\n\nè¯·ç¡®ä¿æ”¯ä»˜æœåŠ¡å™¨å·²å¯åŠ¨ (node payment-server.js)`, 'error');
            }
        }
        
        function testQRCode() {
            try {
                showResult('æ­£åœ¨æµ‹è¯•äºŒç»´ç ç”Ÿæˆ...', 'info');
                
                const testUrl = 'weixin://wxpay/bizpayurl?pr=test123';
                const qrContainer = document.createElement('div');
                qrContainer.style.margin = '20px 0';
                
                new QRCode(qrContainer, {
                    text: testUrl,
                    width: 200,
                    height: 200,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                showResult('âœ… äºŒç»´ç ç”ŸæˆåŠŸèƒ½æ­£å¸¸ï¼', 'success');
                
                // æ˜¾ç¤ºäºŒç»´ç 
                const resultDiv = document.getElementById('test-result');
                resultDiv.appendChild(qrContainer);
                
            } catch (error) {
                showResult(`âŒ äºŒç»´ç ç”Ÿæˆå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function testPaymentModal() {
            try {
                showResult('æ­£åœ¨æµ‹è¯•æ”¯ä»˜æ¨¡æ€æ¡†...', 'info');
                
                // åˆ›å»ºæµ‹è¯•æ¨¡æ€æ¡†
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 12px; text-align: center; max-width: 400px;">
                        <h3>æµ‹è¯•æ”¯ä»˜æ¨¡æ€æ¡†</h3>
                        <p>è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¨¡æ€æ¡†</p>
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="background: #3079E3; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(48, 121, 227, 0.3);">
                            å…³é—­
                        </button>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                showResult('âœ… æ”¯ä»˜æ¨¡æ€æ¡†æ˜¾ç¤ºæ­£å¸¸ï¼', 'success');
                
                // 3ç§’åè‡ªåŠ¨å…³é—­
                setTimeout(() => {
                    if (modal.parentElement) {
                        modal.remove();
                    }
                }, 3000);
                
            } catch (error) {
                showResult(`âŒ æ”¯ä»˜æ¨¡æ€æ¡†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function testCountdown() {
            try {
                showResult('æ­£åœ¨æµ‹è¯•å€’è®¡æ—¶åŠŸèƒ½...', 'info');
                
                // åˆ›å»ºæµ‹è¯•å€’è®¡æ—¶
                let testTime = 10; // 10ç§’æµ‹è¯•
                const testElement = document.createElement('div');
                testElement.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
                        <h4>å€’è®¡æ—¶æµ‹è¯•</h4>
                        <div id="test-countdown" style="font-size: 24px; font-weight: bold; color: #dc3545; font-family: monospace;">${testTime}</div>
                        <p>å€’è®¡æ—¶ç»“æŸåå°†æ˜¾ç¤ºå®Œæˆæç¤º</p>
                    </div>
                `;
                
                const resultDiv = document.getElementById('test-result');
                resultDiv.appendChild(testElement);
                
                const countdownElement = testElement.querySelector('#test-countdown');
                
                const countdownInterval = setInterval(() => {
                    testTime--;
                    countdownElement.textContent = testTime;
                    
                    if (testTime <= 3) {
                        countdownElement.style.color = '#dc3545';
                        countdownElement.style.animation = 'pulse 0.5s infinite';
                    }
                    
                    if (testTime <= 0) {
                        clearInterval(countdownInterval);
                        countdownElement.textContent = 'å®Œæˆï¼';
                        countdownElement.style.color = '#28a745';
                        countdownElement.style.animation = 'none';
                        
                        showResult('âœ… å€’è®¡æ—¶åŠŸèƒ½æµ‹è¯•å®Œæˆï¼', 'success');
                        
                        // 3ç§’åç§»é™¤æµ‹è¯•å…ƒç´ 
                        setTimeout(() => {
                            testElement.remove();
                        }, 3000);
                    }
                }, 1000);
                
            } catch (error) {
                showResult(`âŒ å€’è®¡æ—¶æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function testErrorHandling() {
            try {
                showResult('æ­£åœ¨æµ‹è¯•é”™è¯¯å¤„ç†åŠŸèƒ½...', 'info');
                
                // æ¨¡æ‹Ÿä¸åŒç±»å‹çš„é”™è¯¯
                const errors = [
                    { message: 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•', type: 'error' },
                    { message: 'æœåŠ¡å™¨æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•', type: 'warning' },
                    { message: 'è¯·å…ˆç™»å½•åå†è´­ä¹°', type: 'error' }
                ];
                
                let index = 0;
                const showNextError = () => {
                    if (index < errors.length) {
                        const error = errors[index];
                        
                        // åˆ›å»ºé”™è¯¯æç¤º
                        const errorDiv = document.createElement('div');
                        errorDiv.className = `payment-error ${error.type}`;
                        errorDiv.style.position = 'relative';
                        errorDiv.style.margin = '10px 0';
                        errorDiv.innerHTML = `
                            <div class="error-content">
                                <div class="error-icon">${error.type === 'error' ? 'âŒ' : 'âš ï¸'}</div>
                                <div class="error-message">${error.message}</div>
                                <button class="error-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
                            </div>
                        `;
                        
                        const resultDiv = document.getElementById('test-result');
                        resultDiv.appendChild(errorDiv);
                        
                        index++;
                        
                        // 3ç§’åæ˜¾ç¤ºä¸‹ä¸€ä¸ªé”™è¯¯
                        setTimeout(showNextError, 3000);
                    } else {
                        showResult('âœ… é”™è¯¯å¤„ç†åŠŸèƒ½æµ‹è¯•å®Œæˆï¼', 'success');
                    }
                };
                
                showNextError();
                
            } catch (error) {
                showResult(`âŒ é”™è¯¯å¤„ç†æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ§ª æ”¯ä»˜åŠŸèƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½');
            console.log('ğŸ“‹ è¯·æŒ‰é¡ºåºæµ‹è¯•å„ä¸ªåŠŸèƒ½');
        });
    </script>
</body>
</html>
