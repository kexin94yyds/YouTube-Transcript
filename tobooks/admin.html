<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™½åå•ç®¡ç† - Tobooks Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .login-section {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 400px;
            margin: 100px auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .login-section h2 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .admin-panel {
            display: none;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .user-list {
            margin-top: 20px;
        }

        .user-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .user-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .user-info {
            flex: 1;
        }

        .user-email {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }

        .user-meta {
            font-size: 12px;
            color: #666;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 8px;
        }

        .badge-active {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .message-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .message-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .logout-btn {
            position: absolute;
            top: 30px;
            right: 30px;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="login-section" class="login-section">
        <h2>ğŸ” ç®¡ç†å‘˜ç™»å½•</h2>
        <div class="form-group">
            <label>ç®¡ç†å‘˜å¯†ç </label>
            <input type="password" id="admin-password" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
        </div>
        <button class="btn btn-primary" onclick="adminLogin()" style="width: 100%;">
            ğŸ”“ ç™»å½•
        </button>
        <div id="login-message" style="margin-top: 16px;"></div>
    </div>

    <!-- ç®¡ç†é¢æ¿ -->
    <div id="admin-panel" class="admin-panel">
        <div class="container">
            <div class="header" style="position: relative;">
                <h1>ğŸ“ ç™½åå•ç®¡ç†ç³»ç»Ÿ</h1>
                <p>ç®¡ç†ä»˜è´¹ç”¨æˆ·å’Œç™½åå•å­¦å‘˜</p>
                <button class="btn btn-secondary logout-btn" onclick="adminLogout()">
                    ğŸšª é€€å‡ºç™»å½•
                </button>
            </div>

            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-users">0</div>
                    <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-users">0</div>
                    <div class="stat-label">æ´»è·ƒç”¨æˆ·</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="whitelist-users">0</div>
                    <div class="stat-label">ç™½åå•ç”¨æˆ·</div>
                </div>
            </div>

            <!-- æ·»åŠ ç”¨æˆ· -->
            <div class="card">
                <h2>â• æ·»åŠ ç™½åå•ç”¨æˆ·</h2>
                <div id="add-message"></div>
                <div class="form-group">
                    <label>å­¦å‘˜é‚®ç®± *</label>
                    <input type="email" id="new-email" placeholder="student@example.com" required>
                </div>
                <div class="form-group">
                    <label>å­¦å‘˜å§“å</label>
                    <input type="text" id="new-name" placeholder="å¼ ä¸‰ï¼ˆå¯é€‰ï¼‰">
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨</label>
                    <textarea id="new-notes" rows="3" placeholder="ä¾‹å¦‚ï¼š2024æ˜¥å­£ç­å­¦å‘˜"></textarea>
                </div>
                <button class="btn btn-primary" onclick="addWhitelistUser()">
                    âœ… æ·»åŠ åˆ°ç™½åå•
                </button>
            </div>

            <!-- ç”¨æˆ·åˆ—è¡¨ -->
            <div class="card">
                <h2>ğŸ‘¥ ç™½åå•ç”¨æˆ·åˆ—è¡¨</h2>
                <div id="user-list-container">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="supabaseClient.js"></script>
    <script>
        // ç®¡ç†å‘˜å¯†ç ï¼ˆå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼‰
        const ADMIN_PASSWORD = 'kx94yyds2024';
        
        let supabase = null;
        let users = [];

        // åˆå§‹åŒ–
        async function init() {
            // ç­‰å¾… Supabase åˆå§‹åŒ–
            await new Promise(resolve => setTimeout(resolve, 500));
            supabase = window.supabaseClient?.getClient();
            
            if (!supabase) {
                console.error('âŒ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn') === 'true';
            if (isLoggedIn) {
                showAdminPanel();
            }
        }

        // ç®¡ç†å‘˜ç™»å½•
        function adminLogin() {
            const password = document.getElementById('admin-password').value;
            const messageDiv = document.getElementById('login-message');
            
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('adminLoggedIn', 'true');
                showAdminPanel();
            } else {
                messageDiv.innerHTML = '<div class="message message-error">âŒ å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•</div>';
            }
        }

        // ç®¡ç†å‘˜ç™»å‡º
        function adminLogout() {
            sessionStorage.removeItem('adminLoggedIn');
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('admin-password').value = '';
        }

        // æ˜¾ç¤ºç®¡ç†é¢æ¿
        async function showAdminPanel() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            await loadUsers();
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            try {
                const { data, error } = await supabase
                    .from('premium_users')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                users = data || [];
                updateStats();
                renderUserList();
            } catch (error) {
                console.error('âŒ åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                showMessage('user-list-container', 'åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            const total = users.length;
            const active = users.filter(u => u.is_active).length;
            const whitelist = users.filter(u => u.payment_status === 'whitelist' || u.payment_status === 'free').length;

            document.getElementById('total-users').textContent = total;
            document.getElementById('active-users').textContent = active;
            document.getElementById('whitelist-users').textContent = whitelist;
        }

        // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
        function renderUserList() {
            const container = document.getElementById('user-list-container');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                        <p>è¿˜æ²¡æœ‰ç”¨æˆ·</p>
                    </div>
                `;
                return;
            }

            const html = users.map(user => `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-email">
                            ğŸ“§ ${user.email}
                            <span class="badge ${user.is_active ? 'badge-active' : 'badge-inactive'}">
                                ${user.is_active ? 'âœ“ æ¿€æ´»' : 'âœ— æœªæ¿€æ´»'}
                            </span>
                        </div>
                        <div class="user-meta">
                            ${user.display_name ? 'ğŸ‘¤ ' + user.display_name + ' | ' : ''}
                            ğŸ’³ ${user.payment_status || 'unknown'} | 
                            ğŸ“… ${new Date(user.created_at).toLocaleDateString('zh-CN')}
                            ${user.notes ? ' | ğŸ“ ' + user.notes : ''}
                        </div>
                    </div>
                    <div class="user-actions">
                        ${user.is_active 
                            ? `<button class="btn btn-secondary" onclick="toggleUserStatus('${user.email}', false)">åœç”¨</button>`
                            : `<button class="btn btn-primary" onclick="toggleUserStatus('${user.email}', true)">æ¿€æ´»</button>`
                        }
                        <button class="btn btn-danger" onclick="deleteUser('${user.email}')">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `<div class="user-list">${html}</div>`;
        }

        // æ·»åŠ ç™½åå•ç”¨æˆ·
        async function addWhitelistUser() {
            const email = document.getElementById('new-email').value.trim();
            const name = document.getElementById('new-name').value.trim();
            const notes = document.getElementById('new-notes').value.trim();
            const messageDiv = document.getElementById('add-message');

            if (!email) {
                showMessage('add-message', 'è¯·è¾“å…¥é‚®ç®±', 'error');
                return;
            }

            // éªŒè¯é‚®ç®±æ ¼å¼
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage('add-message', 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®', 'error');
                return;
            }

            try {
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
                const { data: existing } = await supabase
                    .from('premium_users')
                    .select('*')
                    .eq('email', email)
                    .single();

                if (existing) {
                    showMessage('add-message', 'è¯¥é‚®ç®±å·²å­˜åœ¨ï¼Œè¯·ç›´æ¥åœ¨åˆ—è¡¨ä¸­ç®¡ç†', 'error');
                    return;
                }

                // æ’å…¥æ–°ç”¨æˆ·
                const { error } = await supabase
                    .from('premium_users')
                    .insert({
                        email: email,
                        display_name: name || email,
                        is_active: true,
                        payment_status: 'whitelist',
                        site: 'tobooks',
                        notes: notes || 'ç™½åå•ç”¨æˆ·',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;

                showMessage('add-message', `âœ… æˆåŠŸæ·»åŠ  ${email} åˆ°ç™½åå•ï¼`, 'success');
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('new-email').value = '';
                document.getElementById('new-name').value = '';
                document.getElementById('new-notes').value = '';

                // é‡æ–°åŠ è½½åˆ—è¡¨
                await loadUsers();

            } catch (error) {
                console.error('âŒ æ·»åŠ ç”¨æˆ·å¤±è´¥:', error);
                showMessage('add-message', 'æ·»åŠ å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
        async function toggleUserStatus(email, isActive) {
            try {
                const { error } = await supabase
                    .from('premium_users')
                    .update({ 
                        is_active: isActive,
                        updated_at: new Date().toISOString()
                    })
                    .eq('email', email);

                if (error) throw error;

                await loadUsers();
            } catch (error) {
                console.error('âŒ æ›´æ–°ç”¨æˆ·çŠ¶æ€å¤±è´¥:', error);
                alert('æ›´æ–°å¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(email) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${email} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('premium_users')
                    .delete()
                    .eq('email', email);

                if (error) throw error;

                await loadUsers();
            } catch (error) {
                console.error('âŒ åˆ é™¤ç”¨æˆ·å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'message-success' : 'message-error';
            element.innerHTML = `<div class="message ${className}">${message}</div>`;
            
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);

        // å›è½¦ç™»å½•
        document.addEventListener('DOMContentLoaded', () => {
            const passwordInput = document.getElementById('admin-password');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        adminLogin();
                    }
                });
            }
        });
    </script>
</body>
</html>
