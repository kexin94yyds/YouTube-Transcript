# ğŸ‰ EPUBé˜…è¯»å™¨ - ä»ç§é’¥å‡çº§åˆ°ç™»å½•+æ”¯ä»˜ç³»ç»Ÿ

## ğŸ“‹ å‡çº§å®Œæˆæ¸…å•

âœ… **å·²å®Œæˆçš„é›†æˆï¼š**

### 1. Supabase é…ç½® (`supabaseClient.js`)
- âœ… æ”¯æŒ Google ç™»å½•
- âœ… æ”¯æŒé‚®ç®±ï¼ˆQQé‚®ç®±ç­‰ï¼‰ç™»å½•
- âœ… è‡ªåŠ¨åˆå§‹åŒ–å®¢æˆ·ç«¯
- âœ… æä¾›ç»Ÿä¸€çš„è®¤è¯æ¥å£

### 2. ç™»å½•é¡µé¢ (`login.html`)
- âœ… ç¾è§‚çš„ç™»å½•ç•Œé¢
- âœ… æ”¯æŒ Google ä¸€é”®ç™»å½•
- âœ… æ”¯æŒé‚®ç®±é­”æ³•é“¾æ¥ç™»å½•
- âœ… è‡ªåŠ¨è·³è½¬åŠŸèƒ½

### 3. æ”¯ä»˜åŠŸèƒ½ (`payment.js`)
- âœ… é›†æˆå¾®ä¿¡Nativeæ”¯ä»˜
- âœ… è¿æ¥é˜¿é‡Œäº‘FC API
- âœ… è‡ªåŠ¨æ£€æŸ¥ç™½åå•çŠ¶æ€
- âœ… è¯•ç”¨æ¬¡æ•°ç®¡ç†ï¼ˆ30æ¬¡ï¼‰
- âœ… æ”¯ä»˜çŠ¶æ€è½®è¯¢

### 4. åŠŸèƒ½æ§åˆ¶ (`premium-control.js`)
- âœ… è‡ªåŠ¨é”å®š/è§£é”åŠŸèƒ½
- âœ… è¯•ç”¨æ¬¡æ•°æ˜¾ç¤º
- âœ… è´­ä¹°æç¤ºå¼¹çª—
- âœ… è¯•ç”¨æŒ‡ç¤ºå™¨

### 5. ç”¨æˆ·ç®¡ç† (`user-auth.js`)
- âœ… ç”¨æˆ·ç™»å½•çŠ¶æ€æ£€æŸ¥
- âœ… ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
- âœ… ç”¨æˆ·å¤´åƒç”Ÿæˆ
- âœ… é€€å‡ºç™»å½•åŠŸèƒ½

### 6. ä¸»é¡µé¢é›†æˆ (`index.html`)
- âœ… æ·»åŠ ç™»å½•æŒ‰é’®
- âœ… ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
- âœ… æ”¯ä»˜æ¨¡æ€æ¡†
- âœ… æ‰€æœ‰å¿…è¦çš„CSSæ ·å¼

---

## ğŸš€ å¦‚ä½•ä½¿ç”¨æ–°ç³»ç»Ÿ

### ç”¨æˆ·æµç¨‹

1. **è®¿é—®ç½‘ç«™** â†’ çœ‹åˆ°ä¸»é¡µï¼Œå³ä¸Šè§’æ˜¾ç¤º"ç™»å½•"æŒ‰é’®
2. **ç‚¹å‡»ç™»å½•** â†’ è·³è½¬åˆ°ç™»å½•é¡µé¢
3. **é€‰æ‹©ç™»å½•æ–¹å¼**ï¼š
   - Google è´¦å·ä¸€é”®ç™»å½•
   - æˆ–è¾“å…¥é‚®ç®±ï¼Œæ”¶éªŒè¯é‚®ä»¶ç™»å½•
4. **ç™»å½•æˆåŠŸ** â†’ è‡ªåŠ¨è·³è½¬å›ä¸»é¡µï¼Œæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
5. **ä½¿ç”¨åŠŸèƒ½** â†’ å‰30æ¬¡å…è´¹è¯•ç”¨
6. **è¯•ç”¨ç»“æŸ** â†’ æ˜¾ç¤ºè´­ä¹°æç¤º
7. **ç‚¹å‡»è´­ä¹°** â†’ æ˜¾ç¤ºå¾®ä¿¡æ”¯ä»˜äºŒç»´ç 
8. **æ‰«ç æ”¯ä»˜** â†’ è‡ªåŠ¨æ£€æµ‹æ”¯ä»˜æˆåŠŸï¼Œè§£é”æ‰€æœ‰åŠŸèƒ½

---

## ğŸ”§ é…ç½®æ­¥éª¤

### 1. Supabase é…ç½®

å½“å‰å·²é…ç½®çš„ Supabase é¡¹ç›®ï¼š
- **URL**: `https://dpmrdhjltbhbhguuwxwy.supabase.co`
- **é¡¹ç›®åç§°**: ä¸ Attention Span Tracker å…±ç”¨

#### éœ€è¦åœ¨ Supabase ä¸­é…ç½®ï¼š

1. **åˆ›å»ºç™½åå•è¡¨** (å¦‚æœè¿˜æ²¡æœ‰):

```sql
-- æ–¹æ¡ˆAï¼šä½¿ç”¨å…±äº«çš„ premium_users è¡¨ï¼Œæ·»åŠ  site å­—æ®µ
ALTER TABLE premium_users 
ADD COLUMN IF NOT EXISTS site VARCHAR(50) DEFAULT 'attention-span';

CREATE INDEX IF NOT EXISTS idx_premium_users_site 
ON premium_users(site, email);

-- æ·»åŠ æµ‹è¯•ç™½åå•ç”¨æˆ·
INSERT INTO premium_users (email, display_name, is_active, site, notes)
VALUES ('test@example.com', 'æµ‹è¯•ç”¨æˆ·', true, 'epub-reader', 'æµ‹è¯•è´¦å·');
```

æˆ–

```sql
-- æ–¹æ¡ˆBï¼šåˆ›å»ºç‹¬ç«‹çš„ç™½åå•è¡¨
CREATE TABLE IF NOT EXISTS epub_premium_users (
  id BIGSERIAL PRIMARY KEY,
  email TEXT NOT NULL,
  display_name TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now(),
  notes TEXT
);

CREATE INDEX idx_epub_premium_email ON epub_premium_users(email);
```

2. **é…ç½®è®¤è¯è®¾ç½®**ï¼š
   - è¿›å…¥ Supabase Dashboard
   - **Authentication** â†’ **URL Configuration**
   - **Site URL**: `https://your-epub-reader.netlify.app`
   - **Redirect URLs** æ·»åŠ :
     - `https://your-epub-reader.netlify.app/**`
     - `https://your-epub-reader.netlify.app/index.html`

3. **å¯ç”¨ç™»å½•æ–¹å¼**ï¼š
   - **Authentication** â†’ **Providers**
   - å¯ç”¨ **Google** (å·²é…ç½®)
   - å¯ç”¨ **Email** (é‚®ç®±ç™»å½•)

### 2. é˜¿é‡Œäº‘ FC é…ç½®

å½“å‰å·²é…ç½®çš„é˜¿é‡Œäº‘FCï¼š
- **URL**: `https://wechat-y-server-vjfbztievl.cn-shanghai.fcapp.run`

**ç¡®ä¿åç«¯æ”¯æŒçš„ API**ï¼š
- âœ… `POST /api/create-payment` - åˆ›å»ºæ”¯ä»˜è®¢å•
- âœ… `GET /api/payment-status/:orderNo` - æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
- âœ… `POST /api/payment-notify` - å¾®ä¿¡æ”¯ä»˜å›è°ƒ

### 3. å¾®ä¿¡æ”¯ä»˜é…ç½®

åœ¨ `nativePaySDK/payment-server.js` ä¸­å·²é…ç½®ï¼š
```javascript
const WECHAT_CONFIG = {
    appid: 'wx038890243a70a4dd',
    mchid: '1728944790',
    // ... å…¶ä»–é…ç½®
};
```

**ç¡®è®¤è®¾ç½®**ï¼š
1. å¾®ä¿¡å•†æˆ·å¹³å° â†’ å¼€å‘é…ç½®
2. **æ”¯ä»˜å›è°ƒURL**: `https://wechat-y-server-vjfbztievl.cn-shanghai.fcapp.run/api/payment-notify`
3. **æˆæƒåŸŸå**: æ·»åŠ ä½ çš„ Netlify åŸŸå

### 4. ä¿®æ”¹å‰ç«¯é…ç½®

**âš ï¸ é‡è¦ï¼šéœ€è¦ä¿®æ”¹ `login.html` ä¸­çš„é‡å®šå‘URL**

åœ¨ `login.html` çš„ç¬¬ 130 è¡Œå·¦å³ï¼š
```javascript
return isLocal ?
    `${window.location.protocol}//${window.location.host}/index.html` :
    'https://your-epub-reader.netlify.app/index.html'; // âš ï¸ æ”¹æˆä½ çš„å®é™…URL
```

æ”¹æˆï¼š
```javascript
return isLocal ?
    `${window.location.protocol}//${window.location.host}/index.html` :
    'https://ä½ çš„å®é™…åŸŸå.netlify.app/index.html';
```

---

## ğŸ§ª æµ‹è¯•æµç¨‹

### æœ¬åœ°æµ‹è¯•

1. **å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨**ï¼š
```bash
# ä½¿ç”¨ Python
python -m http.server 8000

# æˆ–ä½¿ç”¨ Node.js
npx http-server -p 8000
```

2. **è®¿é—®**: `http://localhost:8000`

3. **æµ‹è¯•ç™»å½•**ï¼š
   - ç‚¹å‡»"ç™»å½•"æŒ‰é’®
   - å°è¯• Google ç™»å½•
   - å°è¯•é‚®ç®±ç™»å½•

4. **æµ‹è¯•æ”¯ä»˜æµç¨‹**ï¼š
   - ç™»å½•åä½¿ç”¨åŠŸèƒ½30æ¬¡
   - è§¦å‘è´­ä¹°æç¤º
   - ç‚¹å‡»è´­ä¹°æŒ‰é’®
   - æŸ¥çœ‹æ”¯ä»˜äºŒç»´ç æ˜¯å¦æ­£ç¡®ç”Ÿæˆ

### çº¿ä¸Šæµ‹è¯•

1. **éƒ¨ç½²åˆ° Netlify**ï¼š
```bash
# å®‰è£… Netlify CLI
npm install -g netlify-cli

# ç™»å½•
netlify login

# éƒ¨ç½²
netlify deploy --prod
```

2. **é…ç½®ç¯å¢ƒå˜é‡** (åœ¨ Netlify Dashboard):
   - `SUPABASE_URL`
   - `SUPABASE_ANON_KEY`

3. **æµ‹è¯•å®Œæ•´æµç¨‹**ï¼š
   - è®¿é—®çº¿ä¸Šåœ°å€
   - æµ‹è¯•ç™»å½•
   - æµ‹è¯•æ”¯ä»˜ï¼ˆä½¿ç”¨å¾®ä¿¡æ‰«ç ï¼‰
   - éªŒè¯æ”¯ä»˜æˆåŠŸååŠŸèƒ½è§£é”

---

## ğŸ’ ç™½åå•ç”¨æˆ·ç®¡ç†

### æ·»åŠ ç™½åå•ç”¨æˆ·

**æ–¹æ³•1ï¼šSupabase Dashboard**
1. è¿›å…¥ Supabase â†’ Table Editor
2. æ‰“å¼€ `premium_users` è¡¨
3. ç‚¹å‡» "Insert row"
4. å¡«å†™ï¼š
   ```
   email: user@example.com
   display_name: ç”¨æˆ·å
   is_active: true
   site: epub-reader (å¦‚æœä½¿ç”¨æ–¹æ¡ˆA)
   notes: æµ‹è¯•ç”¨æˆ·
   ```
5. ä¿å­˜

**æ–¹æ³•2ï¼šSQL**
```sql
INSERT INTO premium_users (email, display_name, is_active, site, notes)
VALUES 
    ('vip1@example.com', 'VIPç”¨æˆ·1', true, 'epub-reader', 'èµ é€è´¦å·'),
    ('vip2@example.com', 'VIPç”¨æˆ·2', true, 'all', 'å…¨ç«™VIP');
```

### ç™½åå•ç”¨æˆ·ç‰¹æƒ
- âœ… ç™»å½•åè‡ªåŠ¨è§£é”æ‰€æœ‰åŠŸèƒ½
- âœ… ä¸å—è¯•ç”¨æ¬¡æ•°é™åˆ¶
- âœ… å³ä¸Šè§’æ˜¾ç¤º"âœ¨ ç™½åå•ç”¨æˆ·"æ ‡è¯†

---

## ğŸ“Š æ•°æ®å­˜å‚¨è¯´æ˜

### localStorage å­˜å‚¨çš„æ•°æ®

- `isPremiumUser`: æ˜¯å¦ä¸ºä»˜è´¹ç”¨æˆ· (true/false)
- `whitelistUser`: æ˜¯å¦ä¸ºç™½åå•ç”¨æˆ· (true/false)
- `trialViewCount`: è¯•ç”¨æ¬¡æ•° (0-30)

### å¦‚ä½•æ¸…é™¤æµ‹è¯•æ•°æ®

```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
localStorage.clear();
location.reload();
```

---

## ğŸ”„ ä»ç§é’¥ç³»ç»Ÿè¿ç§»

### æ—§ç³»ç»Ÿï¼ˆç§é’¥éªŒè¯ï¼‰
- ç”¨æˆ·éœ€è¦è¾“å…¥ç§é’¥æ‰èƒ½è®¿é—®
- ç§é’¥æ–‡ä»¶å­˜å‚¨åœ¨ `keys/` ç›®å½•
- ä½¿ç”¨ `auth-permanent.js` è¿›è¡ŒéªŒè¯

### æ–°ç³»ç»Ÿï¼ˆç™»å½•+æ”¯ä»˜ï¼‰
- ç”¨æˆ·ä½¿ç”¨ Google æˆ–é‚®ç®±ç™»å½•
- è¯•ç”¨ 30 æ¬¡åéœ€è¦ä»˜è´¹
- æ”¯ä»˜æˆåŠŸåæ°¸ä¹…è§£é”

### å…±å­˜æ–¹æ¡ˆ

ç›®å‰ä¸¤ä¸ªç³»ç»Ÿå¯ä»¥å…±å­˜ï¼š
- **æ—§ç”¨æˆ·**ï¼šç»§ç»­ä½¿ç”¨ç§é’¥ç™»å½•ï¼ˆ`index.html` ä¿ç•™ç§é’¥è¾“å…¥æ¡†ï¼‰
- **æ–°ç”¨æˆ·**ï¼šä½¿ç”¨ç™»å½•+æ”¯ä»˜ç³»ç»Ÿ

å¦‚æœè¦å®Œå…¨ç§»é™¤ç§é’¥ç³»ç»Ÿï¼Œåˆ é™¤ä»¥ä¸‹ä»£ç å—ï¼š
```html
<!-- åˆ é™¤ index.html ä¸­çš„è¿™éƒ¨åˆ† -->
<div id="auth-container" style="position: relative;">
    <div id="login-form">
        <h2>è¯·ä¸Šä¼ æ‚¨çš„ç§é’¥è¿›è¡Œèº«ä»½éªŒè¯</h2>
        <!-- ... ç§é’¥è¾“å…¥ç›¸å…³ä»£ç  ... -->
    </div>
</div>
```

---

## ğŸ¨ è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹ä»·æ ¼

åœ¨ `payment.js` ä¸­ä¿®æ”¹ï¼š
```javascript
const PAYMENT_CONFIG = {
    PRODUCT_INFO: {
        price: 99.00,   // æ”¹æˆä½ æƒ³è¦çš„ä»·æ ¼ï¼ˆå…ƒï¼‰
        amount: 9900    // price Ã— 100ï¼ˆåˆ†ï¼‰
    }
};
```

åŒæ—¶æ›´æ–° HTML ä¸­æ˜¾ç¤ºçš„ä»·æ ¼ï¼š
- `index.html` ä¸­çš„ "ç«‹å³è´­ä¹° Â¥99.00"
- æ”¯ä»˜å¼¹çª—ä¸­çš„ä»·æ ¼æ˜¾ç¤º

### ä¿®æ”¹è¯•ç”¨æ¬¡æ•°

åœ¨ `payment.js` å’Œ `premium-control.js` ä¸­ä¿®æ”¹ï¼š
```javascript
const FREE_TRIAL_LIMIT = 30; // æ”¹æˆä½ æƒ³è¦çš„æ¬¡æ•°
```

### ä¿®æ”¹äº§å“ä¿¡æ¯

åœ¨ `payment.js` ä¸­ä¿®æ”¹ï¼š
```javascript
const PAYMENT_CONFIG = {
    PRODUCT_INFO: {
        id: 'epub_reader_premium',
        name: 'EPUBé˜…è¯»å™¨å®Œæ•´ç‰ˆ',  // æ”¹æˆä½ çš„äº§å“åç§°
        // ...
    }
};
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: ç”¨æˆ·ç™»å½•åçœ‹ä¸åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Ÿ
**A**: æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ï¼Œç¡®è®¤ Supabase åˆå§‹åŒ–æˆåŠŸã€‚

### Q2: æ”¯ä»˜äºŒç»´ç æ— æ³•ç”Ÿæˆï¼Ÿ
**A**: 
1. æ£€æŸ¥ `qrcode.min.js` æ˜¯å¦æ­£ç¡®åŠ è½½
2. æ£€æŸ¥é˜¿é‡Œäº‘FC APIæ˜¯å¦æ­£å¸¸
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯

### Q3: ç™½åå•ç”¨æˆ·æ²¡æœ‰è‡ªåŠ¨è§£é”ï¼Ÿ
**A**: 
1. ç¡®è®¤é‚®ç®±åœ°å€å®Œå…¨åŒ¹é…
2. æ£€æŸ¥ `is_active` å­—æ®µä¸º `true`
3. æ£€æŸ¥ `site` å­—æ®µæ˜¯å¦æ­£ç¡®ï¼ˆå¦‚æœä½¿ç”¨æ–¹æ¡ˆAï¼‰

### Q4: æ”¯ä»˜æˆåŠŸä½†æ²¡æœ‰è§£é”ï¼Ÿ
**A**: 
1. æ£€æŸ¥æ”¯ä»˜å›è°ƒæ˜¯å¦æ­£ç¡®å¤„ç†
2. æŸ¥çœ‹é˜¿é‡Œäº‘FCçš„æ—¥å¿—
3. æ‰‹åŠ¨è®¾ç½® `localStorage.setItem('isPremiumUser', 'true')`

### Q5: å¦‚ä½•è·¨è®¾å¤‡åŒæ­¥ä»˜è´¹çŠ¶æ€ï¼Ÿ
**A**: å½“å‰åŸºäº localStorageï¼Œä»…åœ¨å½“å‰æµè§ˆå™¨æœ‰æ•ˆã€‚

**å‡çº§æ–¹æ¡ˆ**ï¼š
- åœ¨ Supabase åˆ›å»º `paid_users` è¡¨
- æ”¯ä»˜æˆåŠŸåå†™å…¥æ•°æ®åº“
- ç™»å½•åä»æ•°æ®åº“è¯»å–ä»˜è´¹çŠ¶æ€

---

## ğŸ‰ æ€»ç»“

ä½ ç°åœ¨æ‹¥æœ‰ä¸€ä¸ªå®Œæ•´çš„**ç™»å½•+æ”¯ä»˜**ç³»ç»Ÿï¼

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âœ… æ— éœ€ç®¡ç†ç§é’¥æ–‡ä»¶
- âœ… ç”¨æˆ·ä½“éªŒæ›´å‹å¥½
- âœ… æ”¯æŒç™½åå•ç”¨æˆ·
- âœ… æ”¯æŒè¯•ç”¨åŠŸèƒ½
- âœ… çœŸå®çš„å¾®ä¿¡æ”¯ä»˜é›†æˆ
- âœ… å¯æ‰©å±•åˆ°å¤šä¸ªé¡¹ç›®

**ä¸‹ä¸€æ­¥**ï¼š
1. éƒ¨ç½²åˆ° Netlify
2. é…ç½® Supabase è®¤è¯
3. æµ‹è¯•å®Œæ•´æµç¨‹
4. æ·»åŠ ç™½åå•ç”¨æˆ·
5. ä¸Šçº¿è¿è¥ ğŸš€

---

**ç¥ä½ çš„ EPUB é˜…è¯»å™¨é¡¹ç›®æˆåŠŸï¼** ğŸ“šâœ¨

