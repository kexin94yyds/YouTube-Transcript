// å­˜å‚¨è½¬å½•æ•°æ®
let transcriptData = [];

let currentActiveIndex = -1;
let timeTrackingInterval = null;
let videoElement = null;

// ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
function init() {
    try {
        console.log('[YouTubeè½¬å½•] åˆå§‹åŒ–å¼€å§‹...', {
            url: location.href,
            readyState: document.readyState,
            hasVideo: !!document.querySelector('video')
        });
        
        // æ£€æŸ¥æ˜¯å¦åœ¨è§†é¢‘é¡µé¢
        if (!location.href.includes('/watch')) {
            console.log('[YouTubeè½¬å½•] ä¸åœ¨è§†é¢‘é¡µé¢ï¼Œè·³è¿‡åˆå§‹åŒ–');
            return;
        }
        
        // æ‰¾åˆ°è§†é¢‘æ’­æ”¾å™¨
        videoElement = document.querySelector('video');
        
        if (!videoElement) {
            console.log('[YouTubeè½¬å½•] æœªæ‰¾åˆ°è§†é¢‘å…ƒç´ ï¼Œ1ç§’åé‡è¯•...');
            setTimeout(init, 1000);
            return;
        }
        
        console.log('[YouTubeè½¬å½•] æ‰¾åˆ°è§†é¢‘å…ƒç´ ï¼Œåˆ›å»ºä¾§è¾¹æ ...');
        
        // åˆ›å»ºä¾§è¾¹æ 
        createSidebar();
        
        // è·å–å­—å¹•æ•°æ®
        fetchTranscript();
        
        // ç›‘å¬è§†é¢‘æ’­æ”¾
        videoElement.addEventListener('play', startTimeTracking);
        videoElement.addEventListener('pause', stopTimeTracking);
        videoElement.addEventListener('seeked', updateCurrentHighlight);
        
        console.log('[YouTubeè½¬å½•] åˆå§‹åŒ–å®Œæˆï¼');
    } catch (error) {
        console.error('[YouTubeè½¬å½•] åˆå§‹åŒ–é”™è¯¯:', error);
        // é‡è¯•åˆå§‹åŒ–
        setTimeout(init, 2000);
    }
}

// è·å–YouTubeå­—å¹•
async function fetchTranscript() {
    try {
        console.log('[YouTubeè½¬å½•] å¼€å§‹è·å–å­—å¹•...');
        
        // æ–¹æ³•1: ä»YouTubeé¡µé¢çš„ytInitialPlayerResponseè·å–
        const ytInitialPlayerResponse = await getYtInitialPlayerResponse();
        
        if (ytInitialPlayerResponse) {
            const captions = ytInitialPlayerResponse.captions;
            
            if (!captions || !captions.playerCaptionsTracklistRenderer) {
                console.log('[YouTubeè½¬å½•] æ­¤è§†é¢‘æ²¡æœ‰å­—å¹•');
                showNoTranscriptMessage();
                return;
            }
            
            const captionTracks = captions.playerCaptionsTracklistRenderer.captionTracks;
            
            if (!captionTracks || captionTracks.length === 0) {
                console.log('[YouTubeè½¬å½•] æ²¡æœ‰å¯ç”¨çš„å­—å¹•è½¨é“');
                showNoTranscriptMessage();
                return;
            }
            
            // å¡«å……è¯­è¨€é€‰æ‹©å™¨
            populateLanguageSelector(captionTracks);
            
            // ä¼˜å…ˆé€‰æ‹©ä¸­æ–‡å­—å¹•ï¼Œå¦åˆ™é€‰æ‹©ç¬¬ä¸€ä¸ª
            let selectedTrack = captionTracks.find(track => 
                track.languageCode === 'zh-Hans' || 
                track.languageCode === 'zh-Hant' || 
                track.languageCode === 'zh'
            ) || captionTracks[0];
            
            await loadTranscriptTrack(selectedTrack);
        } else {
            console.log('[YouTubeè½¬å½•] æ— æ³•è·å–è§†é¢‘ä¿¡æ¯');
            showNoTranscriptMessage();
        }
    } catch (error) {
        console.error('[YouTubeè½¬å½•] è·å–å­—å¹•å¤±è´¥:', error);
        showNoTranscriptMessage();
    }
}

// è·å–ytInitialPlayerResponse
function getYtInitialPlayerResponse() {
    return new Promise((resolve) => {
        // æ–¹æ³•1: ä»windowå¯¹è±¡è·å–
        if (window.ytInitialPlayerResponse) {
            resolve(window.ytInitialPlayerResponse);
            return;
        }
        
        // æ–¹æ³•2: ä»é¡µé¢scriptæ ‡ç­¾ä¸­æå–
        const scripts = document.getElementsByTagName('script');
        for (let script of scripts) {
            const content = script.textContent;
            if (content.includes('ytInitialPlayerResponse')) {
                try {
                    const match = content.match(/var ytInitialPlayerResponse = ({.+?});/);
                    if (match && match[1]) {
                        resolve(JSON.parse(match[1]));
                        return;
                    }
                } catch (e) {
                    console.error('[YouTubeè½¬å½•] è§£æytInitialPlayerResponseå¤±è´¥:', e);
                }
            }
        }
        
        // æ–¹æ³•3: å»¶è¿Ÿåå†æ¬¡å°è¯•
        setTimeout(() => {
            if (window.ytInitialPlayerResponse) {
                resolve(window.ytInitialPlayerResponse);
            } else {
                resolve(null);
            }
        }, 1000);
    });
}

// è§£ç HTMLå®ä½“
function decodeHTMLEntities(text) {
    const textarea = document.createElement('textarea');
    textarea.innerHTML = text;
    return textarea.value
        .replace(/\n/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
}

// å¡«å……è¯­è¨€é€‰æ‹©å™¨
function populateLanguageSelector(captionTracks) {
    const languageSelect = document.getElementById('language-select');
    if (!languageSelect || !captionTracks || captionTracks.length === 0) {
        return;
    }
    
    languageSelect.innerHTML = '';
    
    captionTracks.forEach((track, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = track.name?.simpleText || track.languageCode;
        languageSelect.appendChild(option);
    });
    
    // å¦‚æœæœ‰å¤šç§è¯­è¨€ï¼Œæ˜¾ç¤ºé€‰æ‹©å™¨
    if (captionTracks.length > 1) {
        languageSelect.style.display = 'inline-block';
    }
}

// æ ¹æ®é€‰æ‹©çš„è½¨é“è·å–å­—å¹•
async function fetchTranscriptWithTrack(trackIndex) {
    try {
        const ytInitialPlayerResponse = await getYtInitialPlayerResponse();
        if (!ytInitialPlayerResponse?.captions?.playerCaptionsTracklistRenderer?.captionTracks) {
            return;
        }
        
        const captionTracks = ytInitialPlayerResponse.captions.playerCaptionsTracklistRenderer.captionTracks;
        const selectedTrack = captionTracks[trackIndex];
        
        if (selectedTrack) {
            await loadTranscriptTrack(selectedTrack);
        }
    } catch (error) {
        console.error('[YouTubeè½¬å½•] åŠ è½½é€‰å®šå­—å¹•å¤±è´¥:', error);
        showErrorMessage('åŠ è½½å­—å¹•å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

// åŠ è½½å­—å¹•è½¨é“
async function loadTranscriptTrack(selectedTrack) {
    try {
        console.log('[YouTubeè½¬å½•] é€‰æ‹©çš„å­—å¹•è¯­è¨€:', selectedTrack.name?.simpleText || selectedTrack.languageCode);
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        showLoadingMessage('æ­£åœ¨åŠ è½½å­—å¹•...');
        
        // è·å–å­—å¹•URL
        const transcriptUrl = selectedTrack.baseUrl;
        
        // ä¸‹è½½å¹¶è§£æå­—å¹•
        const response = await fetch(transcriptUrl);
        const xmlText = await response.text();
        
        // è§£æXMLå­—å¹•
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
        const textElements = xmlDoc.getElementsByTagName('text');
        
        transcriptData = [];
        
        for (let i = 0; i < textElements.length; i++) {
            const element = textElements[i];
            const start = parseFloat(element.getAttribute('start'));
            const duration = parseFloat(element.getAttribute('dur') || '0');
            const text = decodeHTMLEntities(element.textContent);
            
            if (text.trim()) {  // åªæ·»åŠ éç©ºæ–‡æœ¬
                transcriptData.push({
                    start: start,
                    end: start + duration,
                    text: text
                });
            }
        }
        
        console.log('[YouTubeè½¬å½•] æˆåŠŸè·å–å­—å¹•ï¼Œå…±', transcriptData.length, 'æ¡');
        
        // é‡æ–°æ¸²æŸ“
        renderTranscript();
    } catch (error) {
        console.error('[YouTubeè½¬å½•] åŠ è½½å­—å¹•å¤±è´¥:', error);
        showErrorMessage('å­—å¹•åŠ è½½å¤±è´¥');
    }
}

// æ˜¾ç¤ºåŠ è½½æ¶ˆæ¯
function showLoadingMessage(message = 'åŠ è½½ä¸­...') {
    const container = document.getElementById('transcript-content');
    if (container) {
        container.innerHTML = `
            <div style="padding: 20px; text-align: center; color: #aaa;">
                <div style="margin-bottom: 10px;">â³</div>
                <p>${message}</p>
            </div>
        `;
    }
}

// æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
function showErrorMessage(message) {
    const container = document.getElementById('transcript-content');
    if (container) {
        container.innerHTML = `
            <div style="padding: 20px; text-align: center; color: #ff6b6b;">
                <div style="margin-bottom: 10px;">âŒ</div>
                <p>${message}</p>
                <button onclick="fetchTranscript()" style="margin-top: 10px; padding: 8px 16px; background: #3f3f3f; color: #fff; border: none; border-radius: 4px; cursor: pointer;">é‡è¯•</button>
            </div>
        `;
    }
}

// æ˜¾ç¤ºæ— å­—å¹•æ¶ˆæ¯
function showNoTranscriptMessage() {
    const container = document.getElementById('transcript-content');
    if (container) {
        container.innerHTML = `
            <div style="padding: 20px; text-align: center; color: #aaa;">
                <div style="margin-bottom: 10px;">ğŸ“</div>
                <p>æ­¤è§†é¢‘æ²¡æœ‰å¯ç”¨çš„å­—å¹•</p>
                <p style="font-size: 12px; margin-top: 10px;">è¯·å°è¯•å…¶ä»–æœ‰å­—å¹•çš„è§†é¢‘</p>
            </div>
        `;
    }
}

// åˆ›å»ºä¾§è¾¹æ 
function createSidebar() {
    try {
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const existingSidebar = document.getElementById('transcript-sidebar');
        if (existingSidebar) {
            console.log('[YouTubeè½¬å½•] ä¾§è¾¹æ å·²å­˜åœ¨ï¼Œå…ˆç§»é™¤');
            existingSidebar.remove();
        }
    
        console.log('[YouTubeè½¬å½•] åˆ›å»ºä¾§è¾¹æ å…ƒç´ ...');
        
        // åˆ›å»ºä¾§è¾¹æ å®¹å™¨
        const sidebar = document.createElement('div');
        sidebar.id = 'transcript-sidebar';
        sidebar.className = 'transcript-sidebar';
        
        // ä½¿ç”¨å†…è”æ ·å¼ç¡®ä¿æ˜¾ç¤º
        sidebar.style.cssText = `
            position: fixed !important;
            top: 56px !important;
            right: 0 !important;
            width: 400px !important;
            height: calc(100vh - 56px) !important;
            background-color: #0f0f0f !important;
            border-left: 1px solid #3f3f3f !important;
            z-index: 999999 !important;
            display: flex !important;
            flex-direction: column !important;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.5) !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        `;
        
        // åˆ›å»ºå¤´éƒ¨
        const header = document.createElement('div');
        header.className = 'transcript-header';
        header.style.cssText = `
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 16px 20px !important;
            border-bottom: 1px solid #3f3f3f !important;
            background-color: #212121 !important;
            color: #f1f1f1 !important;
        `;
        
        header.innerHTML = `
            <h3 style="margin: 0; font-size: 16px; color: #f1f1f1;">è½¬å½•æ–‡æœ¬</h3>
            <div class="header-controls" style="display: flex; align-items: center; gap: 8px;">
                <select id="language-select" class="language-select" style="display: none; background: #3f3f3f; border: 1px solid #555; color: #f1f1f1; padding: 4px 8px; border-radius: 4px; font-size: 12px;"></select>
                <button id="refresh-transcript" class="control-btn" title="åˆ·æ–°å­—å¹•" style="background: none; border: none; color: #aaa; cursor: pointer; font-size: 14px; padding: 4px 8px; border-radius: 4px;">â†»</button>
                <button id="toggle-sidebar" class="toggle-btn" style="background: none; border: none; color: #aaa; cursor: pointer; font-size: 14px; padding: 4px 8px; border-radius: 4px;">æ”¶èµ·</button>
            </div>
        `;
        
        // åˆ›å»ºå†…å®¹åŒºåŸŸ
        const content = document.createElement('div');
        content.className = 'transcript-content';
        content.id = 'transcript-content';
        content.style.cssText = `
            flex: 1 !important;
            overflow-y: auto !important;
            padding: 12px !important;
            color: #f1f1f1 !important;
        `;
        
        sidebar.appendChild(header);
        sidebar.appendChild(content);
        document.body.appendChild(sidebar);
        
        console.log('[YouTubeè½¬å½•] ä¾§è¾¹æ å·²æ·»åŠ åˆ°é¡µé¢', sidebar);
        
        // æ¸²æŸ“è½¬å½•æ–‡æœ¬
        renderTranscript();
        
        // ç»‘å®šäº‹ä»¶
        bindSidebarEvents();
        
    } catch (error) {
        console.error('[YouTubeè½¬å½•] åˆ›å»ºä¾§è¾¹æ å¤±è´¥:', error);
    }
}

// ç»‘å®šä¾§è¾¹æ äº‹ä»¶
function bindSidebarEvents() {
    try {
        // ç»‘å®šæ”¶èµ·/å±•å¼€æŒ‰é’®
        const toggleBtn = document.getElementById('toggle-sidebar');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', toggleSidebar);
        }
        
        // ç»‘å®šåˆ·æ–°æŒ‰é’®
        const refreshBtn = document.getElementById('refresh-transcript');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                fetchTranscript();
            });
        }
        
        // ç»‘å®šè¯­è¨€é€‰æ‹©
        const languageSelect = document.getElementById('language-select');
        if (languageSelect) {
            languageSelect.addEventListener('change', (e) => {
                const selectedTrack = e.target.value;
                if (selectedTrack) {
                    fetchTranscriptWithTrack(selectedTrack);
                }
            });
        }
        
        console.log('[YouTubeè½¬å½•] äº‹ä»¶ç»‘å®šå®Œæˆ');
    } catch (error) {
        console.error('[YouTubeè½¬å½•] äº‹ä»¶ç»‘å®šå¤±è´¥:', error);
    }
}

// æ¸²æŸ“è½¬å½•æ–‡æœ¬
function renderTranscript() {
    const container = document.getElementById('transcript-content');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (transcriptData.length === 0) {
        // å¦‚æœæ²¡æœ‰æ•°æ®ä¸”å®¹å™¨ä¸ºç©ºï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (!container.innerHTML || container.innerHTML.trim() === '') {
            showLoadingMessage('æ­£åœ¨åŠ è½½å­—å¹•...');
        }
        return;
    }
    
    transcriptData.forEach((item, index) => {
        const transcriptItem = document.createElement('div');
        transcriptItem.className = 'transcript-item';
        transcriptItem.dataset.index = index;
        transcriptItem.dataset.start = item.start;
        
        // æ·»åŠ å†…è”æ ·å¼
        transcriptItem.style.cssText = `
            padding: 12px !important;
            margin-bottom: 8px !important;
            border-radius: 8px !important;
            cursor: pointer !important;
            transition: background-color 0.2s !important;
            color: #f1f1f1 !important;
        `;
        
        const timestamp = document.createElement('span');
        timestamp.className = 'timestamp';
        timestamp.textContent = formatTime(item.start);
        timestamp.style.cssText = `
            display: inline-block !important;
            font-size: 12px !important;
            color: #aaa !important;
            margin-right: 8px !important;
            font-family: 'Courier New', monospace !important;
            min-width: 45px !important;
        `;
        
        const text = document.createElement('span');
        text.className = 'text';
        text.textContent = item.text;
        text.style.cssText = `
            display: inline !important;
            line-height: 1.6 !important;
        `;
        
        transcriptItem.appendChild(timestamp);
        transcriptItem.appendChild(text);
        
        // æ·»åŠ hoveræ•ˆæœ
        transcriptItem.addEventListener('mouseenter', () => {
            if (!transcriptItem.classList.contains('active')) {
                transcriptItem.style.backgroundColor = '#3f3f3f';
            }
        });
        
        transcriptItem.addEventListener('mouseleave', () => {
            if (!transcriptItem.classList.contains('active')) {
                transcriptItem.style.backgroundColor = 'transparent';
            }
        });
        
        // ç‚¹å‡»è·³è½¬
        transcriptItem.addEventListener('click', () => {
            if (videoElement) {
                videoElement.currentTime = item.start;
                highlightTranscript(index);
            }
        });
        
        container.appendChild(transcriptItem);
    });
}

// æ ¼å¼åŒ–æ—¶é—´
function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

// å¼€å§‹æ—¶é—´è·Ÿè¸ª
function startTimeTracking() {
    stopTimeTracking();
    timeTrackingInterval = setInterval(() => {
        if (videoElement) {
            updateTranscriptHighlight(videoElement.currentTime);
        }
    }, 100);
}

// åœæ­¢æ—¶é—´è·Ÿè¸ª
function stopTimeTracking() {
    if (timeTrackingInterval) {
        clearInterval(timeTrackingInterval);
        timeTrackingInterval = null;
    }
}

// æ›´æ–°é«˜äº®
function updateTranscriptHighlight(currentTime) {
    const currentIndex = transcriptData.findIndex((item, index) => {
        const nextItem = transcriptData[index + 1];
        return currentTime >= item.start && (!nextItem || currentTime < nextItem.start);
    });
    
    if (currentIndex !== -1 && currentIndex !== currentActiveIndex) {
        highlightTranscript(currentIndex);
    }
}

// æ‰‹åŠ¨æ›´æ–°å½“å‰é«˜äº®
function updateCurrentHighlight() {
    if (videoElement) {
        updateTranscriptHighlight(videoElement.currentTime);
    }
}

// é«˜äº®æŒ‡å®šé¡¹
function highlightTranscript(index) {
    try {
        // ç§»é™¤ä¹‹å‰çš„é«˜äº®
        const previousActive = document.querySelector('.transcript-item.active');
        if (previousActive) {
            previousActive.classList.remove('active');
            previousActive.style.backgroundColor = 'transparent';
            const prevTimestamp = previousActive.querySelector('.timestamp');
            if (prevTimestamp) {
                prevTimestamp.style.color = '#aaa';
            }
        }
        
        // æ·»åŠ æ–°çš„é«˜äº®
        const items = document.querySelectorAll('.transcript-item');
        if (items[index]) {
            items[index].classList.add('active');
            items[index].style.backgroundColor = '#065fd4';
            items[index].style.color = '#fff';
            
            const timestamp = items[index].querySelector('.timestamp');
            if (timestamp) {
                timestamp.style.color = '#fff';
            }
            
            // æ»šåŠ¨åˆ°å¯è§†åŒºåŸŸ
            const sidebar = document.getElementById('transcript-content');
            if (sidebar) {
                items[index].scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
            }
        }
        
        currentActiveIndex = index;
    } catch (error) {
        console.error('[YouTubeè½¬å½•] é«˜äº®å¤±è´¥:', error);
    }
}

// åˆ‡æ¢ä¾§è¾¹æ æ˜¾ç¤º/éšè—
function toggleSidebar() {
    const sidebar = document.getElementById('transcript-sidebar');
    const btn = document.getElementById('toggle-sidebar');
    
    if (sidebar.classList.contains('collapsed')) {
        sidebar.classList.remove('collapsed');
        btn.textContent = 'æ”¶èµ·';
    } else {
        sidebar.classList.add('collapsed');
        btn.textContent = 'å±•å¼€';
    }
}

// åˆå§‹åŒ–
console.log('[YouTubeè½¬å½•] æ’ä»¶åŠ è½½ï¼ŒreadyState:', document.readyState);

// ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
function initWhenReady() {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(init, 1000); // ç­‰å¾…YouTubeåŠ è½½
        });
    } else {
        setTimeout(init, 1000); // ç«‹å³åˆå§‹åŒ–ä½†ç»™ä¸€äº›ç¼“å†²æ—¶é—´
    }
}

initWhenReady();

// ç›‘å¬URLå˜åŒ–ï¼ˆYouTubeå•é¡µåº”ç”¨å¯¼èˆªï¼‰
let lastUrl = location.href;
let urlObserver = new MutationObserver(() => {
    const url = location.href;
    if (url !== lastUrl) {
        lastUrl = url;
        if (url.includes('/watch')) {
            console.log('[YouTubeè½¬å½•] æ£€æµ‹åˆ°é¡µé¢å¯¼èˆªï¼Œé‡æ–°åˆå§‹åŒ–...');
            // æ¸…ç†æ—§ä¾§è¾¹æ 
            const existingSidebar = document.getElementById('transcript-sidebar');
            if (existingSidebar) {
                existingSidebar.remove();
            }
            setTimeout(init, 2000); // ç»™æ›´å¤šæ—¶é—´åŠ è½½
        }
    }
});

urlObserver.observe(document, { subtree: true, childList: true });
